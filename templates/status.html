{% extends "base.html" %}

{% block content %}
<div x-data="statusPage()" x-init="initWebsocket()" x-cloak>
    <!-- Header with status information -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-white">
            Device Overview
            <span class="relative inline-flex h-3 w-3 ml-2" :class="connection.status === 'connected' ? 'bg-green-500' : (connection.status === 'connecting' ? 'bg-yellow-500' : 'bg-red-500')" 
                  x-tooltip="connection.status">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full opacity-75" 
                      :class="connection.status === 'connected' ? 'bg-green-400' : (connection.status === 'connecting' ? 'bg-yellow-400' : 'bg-red-400')"></span>
            </span>
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium" 
                  :class="connection.status === 'connected' ? 'bg-green-100 text-green-800' : (connection.status === 'connecting' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800')"
                  x-text="connection.statusText"></span>
            <span class="text-sm text-gray-400 ml-2" x-text="'Last updated: ' + lastUpdated"></span>
        </h1>
        
        <div class="flex items-center space-x-3">
            <button type="button" @click="pogoUpdateAll()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <span>PoGo Update All (<span x-text="pogoLatest"></span>)</span>
            </button>
            
            <button type="button" @click="refreshData()" class="inline-flex items-center px-4 py-2 border border-gray-700 text-sm font-medium rounded-md text-gray-200 bg-gray-800 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" :class="{ 'animate-spin': isRefreshing }">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                Refresh
            </button>
        </div>
    </div>
    
    <!-- Update status indicators -->
    <div class="flex justify-end mb-4">
        <div class="space-x-2">
            <span class="inline-flex items-center px-3 py-1 rounded-md text-sm font-medium" 
                  :class="pifAutoUpdateEnabled ? 'bg-green-900/30 text-green-400 border border-green-700' : 'bg-red-900/30 text-red-400 border border-red-700'">
                PIF Updates: <span x-text="pifAutoUpdateEnabled ? 'Automatic' : 'Manual'" class="ml-1"></span>
            </span>
            
            <span class="inline-flex items-center px-3 py-1 rounded-md text-sm font-medium" 
                  :class="pogoAutoUpdateEnabled ? 'bg-green-900/30 text-green-400 border border-green-700' : 'bg-red-900/30 text-red-400 border border-red-700'">
                PoGO Updates: <span x-text="pogoAutoUpdateEnabled ? 'Automatic' : 'Manual'" class="ml-1"></span>
            </span>
        </div>
    </div>
    
    <!-- Devices table -->
    <div class="bg-dark-800 overflow-hidden shadow rounded-lg">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-700">
                <thead class="bg-dark-800">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider cursor-pointer" @click="sortTable('name')">
                            Name
                            <span class="inline-block ml-1" :class="{ 'rotate-180': sortConfig.direction === 'desc' && sortConfig.key === 'name' }">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" x-show="sortConfig.key === 'name'">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                </svg>
                            </span>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider cursor-pointer" @click="sortTable('ip')">
                            IP / ID
                            <span class="inline-block ml-1" :class="{ 'rotate-180': sortConfig.direction === 'desc' && sortConfig.key === 'ip' }">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" x-show="sortConfig.key === 'ip'">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                </svg>
                            </span>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider cursor-pointer" @click="sortTable('adb')">
                            ADB
                            <span class="inline-block ml-1" :class="{ 'rotate-180': sortConfig.direction === 'desc' && sortConfig.key === 'adb' }">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" x-show="sortConfig.key === 'adb'">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                </svg>
                            </span>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider cursor-pointer" @click="sortTable('alive')">
                            Alive
                            <span class="inline-block ml-1" :class="{ 'rotate-180': sortConfig.direction === 'desc' && sortConfig.key === 'alive' }">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" x-show="sortConfig.key === 'alive'">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                </svg>
                            </span>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider cursor-pointer" @click="sortTable('control')">
                            Control
                            <span class="inline-block ml-1" :class="{ 'rotate-180': sortConfig.direction === 'desc' && sortConfig.key === 'control' }">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" x-show="sortConfig.key === 'control'">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                </svg>
                            </span>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider cursor-pointer" @click="sortTable('pogo')">
                            PoGo
                            <span class="inline-block ml-1" :class="{ 'rotate-180': sortConfig.direction === 'desc' && sortConfig.key === 'pogo' }">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" x-show="sortConfig.key === 'pogo'">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                </svg>
                            </span>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider cursor-pointer" @click="sortTable('mitm')">
                            MITM
                            <span class="inline-block ml-1" :class="{ 'rotate-180': sortConfig.direction === 'desc' && sortConfig.key === 'mitm' }">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" x-show="sortConfig.key === 'mitm'">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                </svg>
                            </span>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider cursor-pointer" @click="sortTable('module')">
                            PIF
                            <span class="inline-block ml-1" :class="{ 'rotate-180': sortConfig.direction === 'desc' && sortConfig.key === 'module' }">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" x-show="sortConfig.key === 'module'">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                </svg>
                            </span>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider cursor-pointer" @click="sortTable('memory')">
                            Memory
                            <span class="inline-block ml-1" :class="{ 'rotate-180': sortConfig.direction === 'desc' && sortConfig.key === 'memory' }">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" x-show="sortConfig.key === 'memory'">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                </svg>
                            </span>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                            Actions
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-dark-800 divide-y divide-gray-700">
                    <template x-for="device in sortedDevices" :key="device.ip">
                        <tr class="hover:bg-gray-800/70 transition-colors">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-100" x-text="device.display_name"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300" x-text="device.ip.includes(':') ? device.ip.split(':')[0] : device.ip"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                                <div class="relative group">
                                    <template x-if="device.status">
                                        <span class="text-green-500">✅</span>
                                    </template>
                                    <template x-if="!device.status">
                                        <div>
                                            <span class="text-red-500 relative">❌</span>
                                            <template x-if="device.adb_error">
                                                <span class="absolute -top-2 -right-2 flex h-4 w-4 items-center justify-center rounded-full bg-red-500 text-xs text-white">!</span>
                                            </template>
                                        </div>
                                    </template>
                                    <template x-if="device.adb_error">
                                        <div class="absolute z-10 invisible group-hover:visible bg-gray-900 text-white text-xs rounded py-1 px-2 -mt-16 ml-4 w-56">
                                            <span x-text="device.adb_error"></span>
                                        </div>
                                    </template>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                                <span x-text="device.is_alive ? '✅' : '❌'" :class="device.is_alive ? 'text-green-500' : 'text-red-500'"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                                <span class="px-2 py-1 text-xs rounded-full" :class="device.control_enabled ? 'bg-green-900/50 text-green-400' : 'bg-gray-800 text-gray-400'" x-text="device.control_enabled ? 'Active' : 'Inactive'"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300" x-text="device.pogo"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300" x-text="device.mitm"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300" x-text="device.module"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300" x-text="formatMemory(device.mem_free)"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium flex flex-wrap gap-2">
                                <div class="dropdown" x-data="{ open: false }">
                                    <button @click="open = !open" class="px-3 py-1 bg-gray-800 hover:bg-gray-700 text-gray-100 rounded-md text-xs border border-gray-600 flex items-center" type="button">
                                        PoGo
                                        <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <div x-show="open" @click.away="open = false" class="origin-top-right absolute mt-2 w-48 rounded-md shadow-lg bg-gray-900 ring-1 ring-black ring-opacity-5 z-10">
                                        <div class="py-1 divide-y divide-gray-700">
                                            <button type="button" @click="updateDevicePogo(device.ip, pogoLatest)" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-800 w-full text-left" x-text="pogoLatest"></button>
                                            <button type="button" @click="updateDevicePogo(device.ip, pogoPrevious)" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-800 w-full text-left" x-text="pogoPrevious"></button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Updated Module Dropdown -->
                                <div class="dropdown" x-data="{ open: false, versions: [], moduleType: 'all' }" x-init="fetchAllModuleVersions()">
                                    <button @click="open = !open" class="px-3 py-1 bg-gray-800 hover:bg-gray-700 text-gray-100 rounded-md text-xs border border-gray-600 flex items-center" type="button">
                                        Module
                                        <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <div x-show="open" @click.away="open = false" class="origin-top-right absolute mt-2 w-72 rounded-md shadow-lg bg-gray-900 ring-1 ring-black ring-opacity-5 z-10">
                                        <div class="py-2 px-2">
                                            <!-- Filter tabs -->
                                            <div class="flex border-b border-gray-700 mb-2 pb-2">
                                                <button @click="moduleType = 'all'" 
                                                        class="px-3 py-1 text-xs rounded-md mr-1 flex-1"
                                                        :class="moduleType === 'all' ? 'bg-blue-600 text-white' : 'bg-gray-800 text-gray-300 hover:bg-gray-700'">
                                                    All Modules
                                                </button>
                                                <button @click="moduleType = 'fork'" 
                                                        class="px-3 py-1 text-xs rounded-md mr-1 flex-1"
                                                        :class="moduleType === 'fork' ? 'bg-blue-600 text-white' : 'bg-gray-800 text-gray-300 hover:bg-gray-700'">
                                                    Fork
                                                </button>
                                                <button @click="moduleType = 'fix'" 
                                                        class="px-3 py-1 text-xs rounded-md flex-1"
                                                        :class="moduleType === 'fix' ? 'bg-blue-600 text-white' : 'bg-gray-800 text-gray-300 hover:bg-gray-700'">
                                                    Fix
                                                </button>
                                            </div>
                                            
                                            <div class="max-h-60 overflow-y-auto divide-y divide-gray-700">
                                                <template x-for="version in filteredVersions()" :key="`${version.module_type}-${version.version}`">
                                                    <button type="button" 
                                                            @click="updateDeviceModule(device.ip, version.version, version.module_type)" 
                                                            class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-800 transition-colors">
                                                        <div class="flex justify-between items-center">
                                                            <div>
                                                                <span class="text-white font-medium" x-text="version.name"></span>
                                                                <span class="text-xs text-gray-500 ml-1" x-text="formatDate(version.published_at)"></span>
                                                            </div>
                                                            <span class="px-1.5 py-0.5 text-xs rounded" 
                                                                  :class="version.module_type === 'fork' ? 'bg-blue-900/40 text-blue-300 border border-blue-800' : 'bg-yellow-900/40 text-yellow-300 border border-yellow-800'"
                                                                  x-text="version.module_type === 'fork' ? 'Fork' : 'Fix'"></span>
                                                        </div>
                                                    </button>
                                                </template>
                                                <div x-show="filteredVersions().length === 0" class="px-4 py-2 text-sm text-gray-500 text-center">
                                                    <template x-if="versions.length === 0">Loading versions...</template>
                                                    <template x-if="versions.length > 0">No versions found</template>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <button type="button" @click="restartDevice(device.ip)" class="px-3 py-1 bg-yellow-900/30 hover:bg-yellow-900/50 text-yellow-500 border border-yellow-700 rounded-md text-xs">
                                    Restart
                                </button>
                                
                                <button type="button" @click="rebootDevice(device.ip)" class="px-3 py-1 bg-red-900/30 hover:bg-red-900/50 text-red-500 border border-red-700 rounded-md text-xs">
                                    Reboot
                                </button>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Update progress modal -->
    <div id="updateModal" x-show="showUpdateModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" x-cloak>
        <div class="bg-dark-800 rounded-lg shadow-xl max-w-md w-full p-6" @click.away="showUpdateModal = false">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-medium text-gray-100">Update in progress...</h3>
                <button @click="showUpdateModal = false" class="text-gray-400 hover:text-gray-200">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="mb-4">
                <div class="overflow-hidden h-2 text-xs flex rounded bg-gray-700">
                    <div class="w-0 flex-none h-full flex justify-center bg-blue-500 transition-all duration-300 ease-out" :style="{ width: updateProgress + '%' }"></div>
                </div>
            </div>
            <p class="text-center text-gray-300">Please wait, this may take a few minutes...</p>
        </div>
    </div>
</div>

<script>
// Alpine.js component for status page
function statusPage() {
    return {
        devices: [],
        sortedDevices: [],
        pogoLatest: "{{ pogo_latest }}",
        pogoPrevious: "{{ pogo_previous }}",
        pogoAutoUpdateEnabled: {% if config.pogo_auto_update_enabled %}true{% else %}false{% endif %},
        pifAutoUpdateEnabled: {% if config.pif_auto_update_enabled %}true{% else %}false{% endif %},
        lastUpdated: new Date().toLocaleTimeString(),
        isRefreshing: false,
        showUpdateModal: false,
        updateProgress: 0,
        sortConfig: {
            key: 'name',
            direction: 'asc'
        },
        connection: {
            status: 'connecting',
            statusText: 'Connecting...'
        },
        socket: null,
        
        // Initialize websocket connection
        initWebsocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/status`;
            
            console.log('Initializing WebSocket connection to:', wsUrl);
            
            // Create a raw WebSocket connection (not using HTMX WebSocket extension)
            this.socket = new WebSocket(wsUrl);
            
            this.socket.onopen = () => {
                console.log('WebSocket connection established');
                this.connection.status = 'connected';
                this.connection.statusText = 'Connected';
                
                // Initial request for data
                this.socket.send('refresh');
            };
            
            this.socket.onmessage = (event) => {
                try {
                    console.log('WebSocket message received');
                    const data = JSON.parse(event.data);
                    this.updateData(data);
                } catch (e) {
                    console.error('Error parsing WebSocket message:', e);
                }
            };
            
            this.socket.onclose = () => {
                console.log('WebSocket connection closed');
                this.connection.status = 'disconnected';
                this.connection.statusText = 'Disconnected';
                
                // Set up AJAX polling as fallback
                this.startAjaxPolling();
                
                // Try to reconnect after a delay
                setTimeout(() => {
                    if (this.connection.status === 'disconnected') {
                        console.log('Attempting to reconnect WebSocket...');
                        this.initWebsocket();
                    }
                }, 5000);
            };
            
            this.socket.onerror = (error) => {
                console.error('WebSocket error:', error);
                this.connection.status = 'disconnected';
                this.connection.statusText = 'Error';
                
                // Switch to AJAX polling on error
                this.startAjaxPolling();
            };
            
            // Add a timeout to switch to AJAX if WebSocket doesn't connect
            setTimeout(() => {
                if (this.connection.status === 'connecting') {
                    console.log('WebSocket connection timed out, switching to AJAX polling');
                    this.connection.statusText = 'Using AJAX';
                    this.startAjaxPolling();
                }
            }, 5000);
        },
        
        // AJAX polling as fallback
        startAjaxPolling() {
            if (this.connection.status !== 'connected') {
                // Initial fetch
                this.refreshData();
                
                // Set polling interval
                const pollInterval = setInterval(() => {
                    // Only continue polling if still disconnected
                    if (this.connection.status !== 'connected') {
                        this.refreshData();
                    } else {
                        // If we've reconnected, stop polling
                        clearInterval(pollInterval);
                    }
                }, 30000); // Every 30 seconds
            }
        },
        
        // Refresh data using AJAX
        refreshData() {
            this.isRefreshing = true;
            
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    this.updateData(data);
                    this.isRefreshing = false;
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    this.isRefreshing = false;
                });
        },
        
        // Update data state
        updateData(data) {
            this.devices = data.devices || [];
            this.sortedDevices = [...this.devices];
            this.pogoLatest = data.pogo_latest || "N/A";
            this.pogoPrevious = data.pogo_previous || "N/A";
            this.pogoAutoUpdateEnabled = data.pogo_auto_update_enabled;
            this.pifAutoUpdateEnabled = data.pif_auto_update_enabled;
            this.lastUpdated = new Date().toLocaleTimeString();
            
            // Update sort
            this.sortTable(this.sortConfig.key, false);
            
            // Update progress modal if update in progress
            if (data.update_in_progress) {
                this.showUpdateModal = true;
                this.updateProgress = data.update_progress;
            } else if (this.updateProgress >= 100) {
                // Hide modal after completion
                setTimeout(() => {
                    this.showUpdateModal = false;
                    this.updateProgress = 0;
                }, 1000);
            }
        },
        
        // Format memory value
        formatMemory(memKB) {
            if (!memKB || memKB <= 0) {
                return "N/A";
            }
            
            // Memory comes in KB
            if (memKB < 1024) {
                return `${(memKB).toFixed(1).replace('.', ',')} kB`;
            }
            
            // Convert to MB
            const memMB = memKB / 1024;
            if (memMB < 1024) {
                return `${memMB.toFixed(2).replace('.', ',')} MB`;
            }
            
            // Convert to GB
            const memGB = memMB / 1024;
            return `${memGB.toFixed(2).replace('.', ',')} GB`;
        },
        
        // Format date for PIF versions
        formatDate(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString();
            } catch (error) {
                return dateString;
            }
        },
        
        // Sort table by column
        sortTable(key, toggleDirection = true) {
            // If clicking the same header, toggle direction
            if (toggleDirection && this.sortConfig.key === key) {
                this.sortConfig.direction = this.sortConfig.direction === 'asc' ? 'desc' : 'asc';
            } else {
                this.sortConfig.key = key;
                // Only change direction if we're toggling
                if (toggleDirection) {
                    this.sortConfig.direction = 'asc';
                }
            }
            
            const multiplier = this.sortConfig.direction === 'asc' ? 1 : -1;
            
            this.sortedDevices = [...this.devices].sort((a, b) => {
                let aValue, bValue;
                
                // Handle different column types
                switch (key) {
                    case 'name':
                        aValue = a.display_name;
                        bValue = b.display_name;
                        return multiplier * aValue.localeCompare(bValue);
                        
                    case 'ip':
                        aValue = a.ip;
                        bValue = b.ip;
                        return multiplier * aValue.localeCompare(bValue);
                        
                    case 'adb':
                    case 'alive':
                        // Boolean values - true should come first in ascending
                        aValue = key === 'adb' ? a.status : a.is_alive;
                        bValue = key === 'adb' ? b.status : b.is_alive;
                        return multiplier * (bValue === aValue ? 0 : aValue ? -1 : 1);
                        
                    case 'control':
                        aValue = a.control_enabled;
                        bValue = b.control_enabled;
                        return multiplier * (bValue === aValue ? 0 : aValue ? -1 : 1);
                        
                    case 'pogo':
                    case 'mitm':
                    case 'module':
                        aValue = a[key];
                        bValue = b[key];
                        
                        // Handle N/A values
                        if (aValue === 'N/A' && bValue === 'N/A') return 0;
                        if (aValue === 'N/A') return multiplier;
                        if (bValue === 'N/A') return -multiplier;
                        
                        // Compare version numbers
                        return multiplier * this.compareVersions(aValue, bValue);
                        
                    case 'memory':
                        aValue = a.mem_free || 0;
                        bValue = b.mem_free || 0;
                        return multiplier * (aValue - bValue);
                        
                    default:
                        return 0;
                }
            });
        },
        
        // Compare version strings
        compareVersions(a, b) {
            const aParts = a.split('.').map(p => parseInt(p) || 0);
            const bParts = b.split('.').map(p => parseInt(p) || 0);
            
            for (let i = 0; i < Math.max(aParts.length, bParts.length); i++) {
                const aPart = aParts[i] || 0;
                const bPart = bParts[i] || 0;
                
                if (aPart !== bPart) {
                    return aPart - bPart;
                }
            }
            
            return 0;
        },
        
        // Fetch all module versions (both Fork and Fix)
        fetchAllModuleVersions() {
            fetch('/api/all-module-versions')
                .then(response => response.json())
                .then(data => {
                    if (data.all) {
                        this.versions = data.all;
                        // Set preferred module type as default filter
                        this.moduleType = data.preferred || 'all';
                    }
                })
                .catch(error => {
                    console.error('Error fetching module versions:', error);
                });
        },

        // Filter versions based on selected module type
        filteredVersions() {
            if (!this.versions) return [];
            if (this.moduleType === 'all') return this.versions.slice(0, 10); // Limit to top 10
            return this.versions
                .filter(v => v.module_type === this.moduleType)
                .slice(0, 10); // Limit to top 10
        },
        
        // Legacy method - kept for compatibility
        fetchPifVersions() {
            fetch('/api/pif-versions')
                .then(response => response.json())
                .then(data => {
                    if (data.versions) {
                        this.versions = data.versions;
                    }
                })
                .catch(error => {
                    console.error('Error fetching PIF versions:', error);
                });
        },
        
        // NEW ACTION METHODS
        
        // PoGo Update All button
        pogoUpdateAll() {
            this.showUpdateModal = true;
            
            const formData = new FormData();
            
            fetch('/pogo/update', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (response.redirected) {
                    // Don't redirect - we'll just update UI
                    this.refreshData();
                }
            })
            .catch(error => {
                console.error('Error during PoGo update:', error);
                alert('Failed to update PoGo on devices');
                this.showUpdateModal = false;
            });
        },
        
        // Update PoGo on single device
        updateDevicePogo(deviceIp, version) {
            this.showUpdateModal = true;
            
            const formData = new FormData();
            formData.append('device_ip', deviceIp);
            formData.append('version', version);
            
            fetch('/pogo/device-update', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (response.redirected) {
                    // Don't redirect - we'll just update UI
                    this.refreshData();
                }
            })
            .catch(error => {
                console.error('Error during PoGo device update:', error);
                alert('Failed to update PoGo on device');
                this.showUpdateModal = false;
            });
        },
        
        // Update Module on single device
        updateDeviceModule(deviceIp, version, moduleType) {
            this.showUpdateModal = true;
            
            const formData = new FormData();
            formData.append('device_ip', deviceIp);
            formData.append('version', version);
            formData.append('module_type', moduleType);
            
            fetch('/pif/device-update', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (response.redirected) {
                    // Don't redirect - we'll just update UI
                    this.refreshData();
                }
            })
            .catch(error => {
                console.error('Error during module update:', error);
                alert('Failed to update module on device');
                this.showUpdateModal = false;
            });
        },
        
        // Restart device apps
        restartDevice(deviceIp) {
            if (!confirm('Restart apps on this device?')) return;
            
            this.isRefreshing = true;
            const formData = new FormData();
            formData.append('device_ip', deviceIp);
            
            fetch('/devices/restart-apps', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (response.redirected) {
                    // Don't redirect - we'll just update UI
                    this.refreshData();
                } else {
                    this.refreshData(); // Refresh device status after operation
                }
            })
            .catch(error => {
                console.error('Error during restart:', error);
                alert('Failed to restart device');
            })
            .finally(() => {
                this.isRefreshing = false;
            });
        },
        
        // Reboot device
        rebootDevice(deviceIp) {
            if (!confirm('Reboot this device? This will take some time.')) return;
            
            this.isRefreshing = true;
            const formData = new FormData();
            formData.append('device_ip', deviceIp);
            
            fetch('/devices/reboot', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (response.redirected) {
                    // Don't redirect - we'll just update UI
                    this.refreshData();
                } else {
                    this.refreshData(); // Refresh device status after operation
                }
            })
            .catch(error => {
                console.error('Error during reboot:', error);
                alert('Failed to reboot device');
            })
            .finally(() => {
                this.isRefreshing = false;
            });
        }
    };
}
</script>
{% endblock %}